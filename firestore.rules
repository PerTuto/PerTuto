rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ──
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // ── User Profiles ──
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // ── Tenant-Scoped Data ──
    // All tenant data requires authentication.
    // The app assigns tenantId client-side based on user profile.
    match /tenants/{tenantId} {
      allow read: if isAuthenticated();

      // Leads
      match /leads/{leadId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }

      // Students
      match /students/{studentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }

      // Courses
      match /courses/{courseId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }

      // Classes (schedule)
      match /classes/{classId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }

      // Availability
      match /availability/{slotId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }

      // Assignments
      match /assignments/{assignmentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if isAuthenticated();
      }

      // Catch-all for any other subcollections under tenants
      match /{subcollection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // ── Default Deny ──
    // Any path not matched above is denied by default.
  }
}
