rules_version='2'

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ──
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      let userDoc = /databases/$(database)/documents/users/$(request.auth.uid);
      return exists(userDoc) ? get(userDoc).data : { 'role': 'guest', 'tenantId': 'none' };
    }

    function isSuper() {
      return isAuthenticated() && (
        request.auth.token.email == 'super@pertuto.com' ||
        getUserData().role == 'super'
      );
    }

    function userBelongsToTenant(tenantId) {
      return isAuthenticated() && (
        request.auth.token.email == 'super@pertuto.com' ||
        getUserData().tenantId == tenantId || 
        isSuper()
      );
    }

    function hasRole(role) {
      return isAuthenticated() && (
        request.auth.token.email == 'super@pertuto.com' ||
        getUserData().role == role || 
        (getUserData().role is list && role in getUserData().role) ||
        isSuper()
      );
    }

    function isAdmin() {
      return hasRole('admin') || hasRole('executive');
    }

    function isTeacher() {
      return hasRole('teacher');
    }

    function isStudent() {
      return hasRole('student');
    }

    function isParent() {
      return hasRole('parent');
    }

    function isStudentOwner() {
      return isStudent() && resource.data.userId == request.auth.uid;
    }

    function isParentOfStudent() {
      return isParent() && resource.data.parentId == request.auth.uid;
    }

    // ── User Profiles ──
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isSuper() || isAdmin();
      allow write: if request.auth.uid == userId || isSuper();
    }

    // ── Invite Tokens ──
    match /invites/{inviteCode} {
      allow read: if true; // Need to validate invite links without auth
      allow write: if isSuper() || isAdmin();
    }

    // ── Public Website Content ──
    match /website_content/{documentId} {
      allow read: if true;
      allow write: if isSuper();
    }

    // ── Tenant-Scoped Data ──
    match /tenants/{tenantId} {
      allow read: if userBelongsToTenant(tenantId);
      
      // Students collection — students and parents can read their own records
      match /students/{studentId} {
        allow read: if userBelongsToTenant(tenantId) && (
          isAdmin() || isSuper() || isTeacher() ||
          isStudentOwner() || isParentOfStudent()
        );
        // Students can update their own profile (limited fields)
        allow update: if userBelongsToTenant(tenantId) && isStudentOwner();
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isSuper());
      }

      // Classes collection
      match /classes/{classId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }

      // Courses collection — students and parents can read
      match /courses/{courseId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }

      // Assignments collection — students can submit, teachers can grade
      match /assignments/{assignmentId} {
        allow read: if userBelongsToTenant(tenantId);
        // Teachers and admins can create and fully update assignments
        allow create: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
        // Students can only update submission-related fields on their own assignments  
        allow update: if userBelongsToTenant(tenantId) && (
          isAdmin() || isTeacher() || isStudent()
        );
        allow delete: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }

      // Invoices — parents can read their linked invoices
      match /invoices/{invoiceId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && isAdmin();
      }

      // Ledger — admin-only write, everyone in tenant can read
      match /ledger/{txId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && isAdmin();
      }

      // Attendance — teachers can mark, students/parents can read
      match /attendance/{recordId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }

      // Leads — admin/executive only
      match /leads/{leadId} {
        allow read: if userBelongsToTenant(tenantId) && (isAdmin() || isSuper());
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isSuper());
      }

      // Resources — public read, admin/teacher write
      match /resources/{resourceId} {
        allow read: if true;
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }

      // Availability — teachers can manage
      match /availability/{slotId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }

      // Testimonials — public read (approved), admin/teacher write
      match /testimonials/{testimonialId} {
        allow read: if userBelongsToTenant(tenantId);
        allow write: if userBelongsToTenant(tenantId) && (isAdmin() || isTeacher());
      }
    }
  }
}
